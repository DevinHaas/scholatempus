name: Deploy Backend to Coolify

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/deploy-backend.yml'
      - 'apps/backend/**'
      - 'packages/shared/**'
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build-and-deploy:
    name: Build and Deploy to Coolify
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Encore CLI
        run: |
          curl -L https://encore.dev/install.sh | bash
          echo "$HOME/.encore/bin" >> $GITHUB_PATH

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate image tags
        id: image-tags
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          
          # Timestamped tag for version history
          VERSIONED_TAG="ghcr.io/${REPO_LOWER}/scholatempus-backend:main-${TIMESTAMP}"
          
          # Stable tag for Coolify to track
          LATEST_TAG="ghcr.io/${REPO_LOWER}/scholatempus-backend:main-latest"
          
          echo "versioned_tag=${VERSIONED_TAG}" >> $GITHUB_OUTPUT
          echo "latest_tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
          echo "Generated tags:"
          echo "  Versioned: ${VERSIONED_TAG}"
          echo "  Latest: ${LATEST_TAG}"

      - name: Build Docker image
        working-directory: ./apps/backend
        run: |
          encore build docker ${{ steps.image-tags.outputs.versioned_tag }}
          echo "Image built successfully: ${{ steps.image-tags.outputs.versioned_tag }}"

      - name: Tag and push Docker images
        run: |
          # Push versioned tag
          docker push ${{ steps.image-tags.outputs.versioned_tag }}
          echo "Pushed: ${{ steps.image-tags.outputs.versioned_tag }}"
          
          # Tag and push latest
          docker tag ${{ steps.image-tags.outputs.versioned_tag }} ${{ steps.image-tags.outputs.latest_tag }}
          docker push ${{ steps.image-tags.outputs.latest_tag }}
          echo "Pushed: ${{ steps.image-tags.outputs.latest_tag }}"

      - name: Trigger Coolify Deployment
        run: |
          curl --request GET "${{ secrets.COOLIFY_WEBHOOK }}" \
            --header "Authorization: Bearer ${{ secrets.COOLIFY_TOKEN }}" \
            --fail-with-body
          echo "Coolify backend deployment triggered successfully"

      - name: Display build info
        run: |
          echo "=========================================="
          echo "Build completed successfully!"
          echo "=========================================="
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Versioned image: ${{ steps.image-tags.outputs.versioned_tag }}"
          echo "Latest image: ${{ steps.image-tags.outputs.latest_tag }}"
          echo "=========================================="


